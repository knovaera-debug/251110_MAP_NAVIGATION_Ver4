<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å®Ÿè»Šè©•ä¾¡æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
<link rel="stylesheet" href="leaflet.css">
<script src="leaflet.js"></script>
<script src="jszip.min.js"></script>
<script src="togeojson.umd.js"></script>
<style>
body { margin:0; font-family:'Segoe UI',sans-serif; }
#map { width:100%; height:100vh; }
.control-box {
  position:absolute; top:10px; left:10px; z-index:9999;
  background:#fff; padding:10px; border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  width:90%; max-width:400px;
}
button { border:none; border-radius:6px; padding:6px 12px; color:#fff; margin:3px; font-size:15px; }
#startBtn { background-color:#007b3d; }
#currentBtn { background-color:#007bff; }
#menuClose { background-color:gray; }
#voiceTest { background-color:#00994c; }
.toast {
  position:absolute; bottom:30px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.75); color:#fff; padding:10px 16px;
  border-radius:8px; z-index:10000; animation:fadeInOut 3s;
}
@keyframes fadeInOut {
  0%{opacity:0;}10%{opacity:1;}90%{opacity:1;}100%{opacity:0;}
}
#menuOpen {
  position:absolute; top:10px; right:10px; z-index:9999;
  background-color:#007bff; color:white; border:none;
  padding:8px 12px; border-radius:8px; display:none;
}
</style>
</head>
<body>
<div class="control-box" id="menuBox">
  <h2>å®Ÿè»Šè©•ä¾¡æ”¯æ´ãƒ„ãƒ¼ãƒ«</h2>
  <label>GitHubãƒ«ãƒ¼ãƒˆé¸æŠï¼š</label>
  <select id="githubRouteSelect"></select><br><br>
  <label>é€šçŸ¥åŠå¾„ (m)ï¼š</label>
  <input type="number" id="notifyDistance" value="120" style="width:80px;"> <br><br>
  <button id="startBtn">è¿½è·¡é–‹å§‹</button>
  <button id="currentBtn">ç¾åœ¨åœ°ã¸</button>
  <button id="voiceTest">éŸ³å£°ãƒ†ã‚¹ãƒˆ</button>
  <button id="menuClose">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹</button>
  <p id="status">åœæ­¢ä¸­</p>
</div>
<button id="menuOpen">âš™ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã</button>
<div id="map"></div>

<script>
const map = L.map('map').setView([35.4515, 139.3964], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom:19,
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

let routeLine=null;
let currentPoints=[];
let userMarker=null;
let watchId=null;
let lastAnnounced=false;
let lastSpokenName=null;
let lastSpeakTime=0;

// ====== Utility ======
function showToast(msg){
  const t=document.createElement("div");
  t.className="toast"; t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}
function speakAsync(text){
  return new Promise(resolve=>{
    const u=new SpeechSynthesisUtterance(text);
    u.lang="ja-JP"; u.pitch=0.9; u.rate=0.95;
    u.onend=()=>setTimeout(resolve,400);
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  });
}
function calcDistance(lat1,lon1,lat2,lon2){
  const R=6371000, toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ====== GitHubãƒ«ãƒ¼ãƒˆ ======
const routes=[
  "data/ãƒ«ãƒ¼ãƒˆTest.kmz",
  "data/Final_å›½å†…DPã‚³ãƒ¼ã‚¹è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆä»˜ã_251007_v10.kmz"
];
const sel=document.getElementById("githubRouteSelect");
routes.forEach(p=>{
  const o=document.createElement("option");
  o.value=p; o.textContent=p.split("/").pop();
  sel.appendChild(o);
});

// ====== KMZèª­è¾¼ ======
async function loadKmzFromGithub(url){
  showToast("ãƒ«ãƒ¼ãƒˆèª­è¾¼ä¸­...");
  const res=await fetch(url);
  const blob=await res.blob();
  const zip=await JSZip.loadAsync(blob);
  const kmlFile=Object.keys(zip.files).find(k=>k.endsWith(".kml"));
  const kmlText=await zip.file(kmlFile).async("string");
  const parser=new DOMParser();
  const kmlDom=parser.parseFromString(kmlText,"text/xml");

  const evalFolder=[...kmlDom.getElementsByTagName("Folder")].find(f=>{
    const n=f.getElementsByTagName("name")[0]?.textContent??"";
    return n.includes("è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆ");
  });
  const placemarks=evalFolder?[...evalFolder.getElementsByTagName("Placemark")]:[...kmlDom.getElementsByTagName("Placemark")];

  if(routeLine) map.removeLayer(routeLine);
  currentPoints.forEach(p=>map.removeLayer(p.marker));
  currentPoints=[];

  placemarks.forEach(pm=>{
    const name=pm.getElementsByTagName("name")[0]?.textContent?.trim()??"";
    const desc=pm.getElementsByTagName("description")[0]?.textContent?.trim()??"";
    const coords=pm.getElementsByTagName("coordinates")[0]?.textContent?.trim();
    if(!coords) return;
    const [lon,lat]=coords.split(",").map(Number);
    const m=L.circleMarker([lat,lon],{radius:8,color:"black",fillColor:"blue",fillOpacity:0.9}).addTo(map);
    currentPoints.push({lat,lng:lon,name,desc,marker:m,notified:false});
  });

  const lines=[...kmlDom.getElementsByTagName("LineString")];
  lines.forEach(line=>{
    const coords=line.getElementsByTagName("coordinates")[0]?.textContent?.trim()??"";
    if(!coords) return;
    const latlngs=coords.split(/\s+/).map(c=>{
      const [lon,lat]=c.split(",").map(Number);
      return [lat,lon];
    });
    routeLine=L.polyline(latlngs,{color:"orange",weight:5}).addTo(map);
  });
  if(routeLine) map.fitBounds(routeLine.getBounds());
  showToast("ãƒ«ãƒ¼ãƒˆèª­è¾¼å®Œäº†");
}
loadKmzFromGithub(sel.value);
sel.addEventListener("change",()=>loadKmzFromGithub(sel.value));

// ===== ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¶å¾¡ =====
document.getElementById("menuClose").addEventListener("click",()=>{
  document.getElementById("menuBox").style.display="none";
  document.getElementById("menuOpen").style.display="block";
});
document.getElementById("menuOpen").addEventListener("click",()=>{
  document.getElementById("menuBox").style.display="block";
  document.getElementById("menuOpen").style.display="none";
});

// ===== è¿½è·¡ =====
document.getElementById("startBtn").addEventListener("click",async()=>{
  if(watchId){
    navigator.geolocation.clearWatch(watchId);
    watchId=null;
    document.getElementById("status").textContent="åœæ­¢ä¸­";
    await speakAsync("è©•ä¾¡ã‚’çµ‚äº†ã—ã¾ã™ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚");
    return;
  }

  const notifyDistance=parseFloat(document.getElementById("notifyDistance").value)||120;
  const resetDistance=notifyDistance+40;
  const lockDuration=15000; // é€šçŸ¥å¾Œ15ç§’ãƒ­ãƒƒã‚¯

  await speakAsync("è©•ä¾¡ã‚’é–‹å§‹ã—ã¾ã™ã€‚");
  document.getElementById("status").textContent="è©•ä¾¡ä¸­";
  lastAnnounced=false; lastSpokenName=null;

  // åˆæœŸä½ç½®æ¡ˆå†…
  const pos=await new Promise((resolve,reject)=>navigator.geolocation.getCurrentPosition(resolve,reject,{enableHighAccuracy:true}));
  const lat=pos.coords.latitude, lon=pos.coords.longitude;
  map.setView([lat,lon],17);

  const nearby=currentPoints.map(p=>({...p,dist:calcDistance(lat,lon,p.lat,p.lng)}))
    .filter(p=>p.dist<=notifyDistance).sort((a,b)=>a.dist-b.dist);
  for(const np of nearby){
    if(!np.notified){
      const msg=np.desc?`${np.name}ã€${np.desc}ã§ã™`:`${np.name}ã§ã™`;
      await speakAsync(msg);
      np.notified=true;
      np.lastNotifyTime=Date.now();
      lastSpokenName=np.name;
    }
  }

  // GPSè¿½è·¡
  watchId=navigator.geolocation.watchPosition(async pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    map.setView([lat,lon]); // è‡ªè»Šã‚’ä¸­å¿ƒã«
    if(!userMarker){
      userMarker=L.circleMarker([lat,lon],{radius:8,color:"red",fillColor:"#f03",fillOpacity:0.9}).addTo(map);
    } else userMarker.setLatLng([lat,lon]);

    const now=Date.now();
    let allReached=true;
    for(const p of currentPoints){
      const dist=calcDistance(lat,lon,p.lat,p.lng);

      // é€šçŸ¥æ¡ä»¶
      if(!p.notified && dist<=notifyDistance && (now-lastSpeakTime>lockDuration)){
        // åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ã‚’çŸ­æ™‚é–“ã§ç¹°ã‚Šè¿”ã•ãªã„
        if(p.name!==lastSpokenName){
          const msg=p.desc?`${p.name}ã€${p.desc}ã§ã™`:`${p.name}ã§ã™`;
          await speakAsync(msg);
          showToast(`ğŸ“${p.name}ï¼ˆç´„${Math.round(dist)}mï¼‰`);
          p.notified=true;
          p.lastNotifyTime=now;
          lastSpokenName=p.name;
          lastSpeakTime=now;
        }
      }

      // å†é€šçŸ¥è§£é™¤æ¡ä»¶
      if(p.notified && dist>resetDistance && (now-p.lastNotifyTime>lockDuration)){
        p.notified=false;
      }

      if(!p.notified) allReached=false;
    }

    if(!lastAnnounced && allReached && currentPoints.length>0){
      lastAnnounced=true;
      await speakAsync("è©•ä¾¡ã‚’çµ‚äº†ã—ã¾ã™ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚");
      navigator.geolocation.clearWatch(watchId);
      watchId=null;
      document.getElementById("status").textContent="çµ‚äº†";
    }
  },err=>showToast("GPSã‚¨ãƒ©ãƒ¼:"+err.message),{enableHighAccuracy:true});
});
</script>
</body>
</html>
