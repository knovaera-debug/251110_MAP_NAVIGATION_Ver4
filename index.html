<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å®Ÿè»Šè©•ä¾¡æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
<link rel="stylesheet" href="leaflet.css" />
<script src="leaflet.js"></script>
<script src="jszip.min.js"></script>
<script src="togeojson.umd.js"></script>

<style>
  html,body{height:100%;margin:0}
  #map{position:fixed; inset:0; background:#f2f2f2;}
  #panel{
    position:fixed; left:10px; top:calc(10px + env(safe-area-inset-top));
    z-index:2147483000; background:#fff; padding:10px 12px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.18); font-family:system-ui,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    min-width:300px; max-width:min(94vw,560px);
  }
  h1{margin:0 0 8px;font-size:15px;font-weight:700}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  .grow{flex:1 1 auto;min-width:160px}
  button{padding:10px 14px; min-height:40px; border-radius:12px; cursor:pointer; border:1px solid #ddd;}
  #start{background:#16a34a;color:#fff;border-color:#16a34a}
  #recenter{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  #cp{background:#f59e0b;color:#fff;border-color:#f59e0b}
  #toast{position:fixed; left:50%; bottom:80px; transform:translateX(-50%);
         display:none; background:rgba(0,0,0,.85); color:#fff; padding:10px 14px;
         border-radius:12px; font-size:14px;}
  #recBadge{position:fixed; right:12px; top:12px; background:#ef4444; color:#fff;
             padding:6px 10px; border-radius:9999px; display:none; align-items:center;}
  .dot{width:10px;height:10px;background:#fff;border-radius:50%;margin-right:6px;animation:blink 1s infinite;}
  @keyframes blink{0%,60%{opacity:1}61%,100%{opacity:.25}}
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h1>å®Ÿè»Šè©•ä¾¡æ”¯æ´ãƒ„ãƒ¼ãƒ«</h1>

  <div class="row">
    <label for="kmzSelect">GitHubä¸Šã®KMZã‚’é¸æŠï¼š</label>
    <select id="kmzSelect" class="grow">
      <option value="">ï¼ˆèª­ã¿è¾¼ã¿ä¸­...ï¼‰</option>
    </select>
    <button id="loadKmz">èª­è¾¼</button>
  </div>

  <div class="row">
    <input type="file" id="file" accept=".kml,.kmz" />
    <span id="fname" style="font-size:11px;color:#555"></span>
  </div>

  <div class="row">
    <button id="start">è¿½è·¡é–‹å§‹</button>
    <button id="recenter">ç¾åœ¨åœ°ã¸</button>
    <button id="cp" disabled>ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ</button>
  </div>
</div>

<div id="recBadge"><div class="dot"></div>è©•ä¾¡ä¸­</div>
<div id="toast"></div>

<script>
const REPO_OWNER = "knovaera-debug"; // â† è‡ªåˆ†ã®GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼å
const REPO_NAME  = "250929_MAP_NAVIGATION_Ver3"; // â† ãƒªãƒã‚¸ãƒˆãƒªå
const DATA_PATH  = "data"; // KMZãŒå…¥ã£ã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€
const BRANCH     = "main"; // ãƒ–ãƒ©ãƒ³ãƒåï¼ˆmainã¾ãŸã¯masterï¼‰

const API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_PATH}?ref=${BRANCH}`;
const RAW_BASE = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${DATA_PATH}/`;

const map = L.map('map').setView([35.6812,139.7671],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let currentLayer=null;

// ğŸ”¹ GitHubã®dataãƒ•ã‚©ãƒ«ãƒ€å†…ã®KMZä¸€è¦§ã‚’å–å¾—
async function loadKmzList(){
  try{
    const resp=await fetch(API_URL);
    const data=await resp.json();
    const select=document.getElementById("kmzSelect");
    select.innerHTML="";
    data.filter(f=>f.name.endsWith(".kmz")).forEach(f=>{
      const opt=document.createElement("option");
      opt.value=f.name;
      opt.textContent=f.name;
      select.appendChild(opt);
    });
    if(select.options.length===0){
      select.innerHTML="<option>ï¼ˆKMZãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰</option>";
    }
  }catch(e){
    alert("GitHubãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ï¼š"+e.message);
  }
}
loadKmzList();

// ğŸ”¹ KMZèª­è¾¼ãƒœã‚¿ãƒ³
document.getElementById("loadKmz").addEventListener("click",async()=>{
  const sel=document.getElementById("kmzSelect").value;
  if(!sel) return alert("KMZã‚’é¸æŠã—ã¦ãã ã•ã„");
  const url=RAW_BASE+encodeURIComponent(sel);
  await loadFromUrl(url);
});

async function loadFromUrl(url){
  showToast("KMZã‚’èª­ã¿è¾¼ã¿ä¸­...");
  try{
    const resp=await fetch(url);
    if(!resp.ok) throw new Error("å–å¾—å¤±æ•—");
    const buf=await resp.arrayBuffer();
    const blob=new Blob([buf]);
    await handleKmlKmzFile(blob,url.split("/").pop());
    showToast("KMZèª­ã¿è¾¼ã¿å®Œäº†");
  }catch(e){
    alert("èª­è¾¼ã‚¨ãƒ©ãƒ¼ï¼š"+e.message);
  }
}

// ğŸ”¹ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼
document.getElementById("file").addEventListener("change",async(e)=>{
  const file=e.target.files[0];
  if(!file) return;
  document.getElementById("fname").textContent=file.name;
  await handleKmlKmzFile(file,file.name);
});

async function handleKmlKmzFile(fileBlob,fileName){
  try{
    let kmlText="";
    if(fileName.endsWith(".kmz")){
      const zip=new JSZip();
      const loaded=await zip.loadAsync(fileBlob);
      const kmlFile=Object.keys(loaded.files).find(f=>f.endsWith(".kml"));
      if(!kmlFile) throw new Error("KMZå†…ã«KMLãªã—");
      kmlText=await loaded.file(kmlFile).async("text");
    }else{
      kmlText=await fileBlob.text();
    }
    parseAndDisplayKml(kmlText);
  }catch(err){alert("è§£æã‚¨ãƒ©ãƒ¼ï¼š"+err.message);}
}

function parseAndDisplayKml(kmlText){
  const parser=new DOMParser();
  const kmlDom=parser.parseFromString(kmlText,"text/xml");
  const geojson=toGeoJSON.kml(kmlDom);
  if(currentLayer){map.removeLayer(currentLayer);}
  currentLayer=L.geoJSON(geojson,{
    style:{color:"#ff6600",weight:4},
    onEachFeature:(f,l)=>{if(f.properties?.name)l.bindPopup(f.properties.name);}
  }).addTo(map);
  try{map.fitBounds(currentLayer.getBounds());}catch{}
}

// ---------- UIæ“ä½œ ----------
document.getElementById("start").addEventListener("click",()=>{
  showToast("è©•ä¾¡ã‚’é–‹å§‹ã—ã¾ã™");
  document.getElementById("recBadge").style.display="flex";
});
document.getElementById("recenter").addEventListener("click",()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      map.setView([p.coords.latitude,p.coords.longitude],16);
    });
  }
});
document.getElementById("cp").addEventListener("click",()=>{
  showToast("ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆç™»éŒ²");
});
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.style.display="block";
  setTimeout(()=>t.style.display="none",2000);
}
</script>
</body>
</html>
