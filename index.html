<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>実車評価支援ツール</title>
<link rel="stylesheet" href="leaflet.css" />
<script src="leaflet.js"></script>
<script src="jszip.min.js"></script>
<script src="togeojson.umd.js"></script>

<style>
  html,body{height:100%;margin:0}
  #map{position:fixed; inset:0; background:#f2f2f2;}
  #panel{
    position:fixed; left:10px; top:calc(10px + env(safe-area-inset-top));
    z-index:2147483000; background:#fff; padding:10px 12px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.18); font-family:system-ui,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    min-width:300px; max-width:min(94vw,560px);
  }
  h1{margin:0 0 8px;font-size:15px;font-weight:700}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  .grow{flex:1 1 auto;min-width:160px}
  button{padding:10px 14px; min-height:40px; border-radius:12px; cursor:pointer; border:1px solid #ddd;}
  #start{background:#16a34a;color:#fff;border-color:#16a34a}
  #recenter{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  #cp{background:#f59e0b;color:#fff;border-color:#f59e0b}
  #toast{position:fixed; left:50%; bottom:80px; transform:translateX(-50%);
         display:none; background:rgba(0,0,0,.85); color:#fff; padding:10px 14px;
         border-radius:12px; font-size:14px;}
  #recBadge{position:fixed; right:12px; top:12px; background:#ef4444; color:#fff;
             padding:6px 10px; border-radius:9999px; display:none; align-items:center;}
  .dot{width:10px;height:10px;background:#fff;border-radius:50%;margin-right:6px;animation:blink 1s infinite;}
  @keyframes blink{0%,60%{opacity:1}61%,100%{opacity:.25}}
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h1>実車評価支援ツール</h1>

  <div class="row">
    <label for="kmzSelect">GitHub上のKMZを選択：</label>
    <select id="kmzSelect" class="grow">
      <option value="">（読み込み中...）</option>
    </select>
    <button id="loadKmz">読込</button>
  </div>

  <div class="row">
    <input type="file" id="file" accept=".kml,.kmz" />
    <span id="fname" style="font-size:11px;color:#555"></span>
  </div>

  <div class="row">
    <button id="start">追跡開始</button>
    <button id="recenter">現在地へ</button>
    <button id="cp" disabled>チェックポイント</button>
  </div>
</div>

<div id="recBadge"><div class="dot"></div>評価中</div>
<div id="toast"></div>

<script>
// ===== GitHub設定 =====
const REPO_OWNER = "knovaera-debug";
const REPO_NAME  = "251110_MAP_NAVIGATION_Ver4";
const DATA_PATH  = "data";
const BRANCH     = "main";

const API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_PATH}?ref=${BRANCH}`;
const RAW_BASE = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${DATA_PATH}/`;

// ===== Leaflet初期化 =====
const map = L.map('map').setView([35.6812,139.7671],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let currentLayer=null;
let routePoints=[];
let watchId=null;

// ===== KMZ一覧をGitHubから取得 =====
async function loadKmzList(){
  try{
    const resp=await fetch(API_URL);
    const data=await resp.json();
    const select=document.getElementById("kmzSelect");
    select.innerHTML="";
    data.filter(f=>f.name.endsWith(".kmz")).forEach(f=>{
      const opt=document.createElement("option");
      opt.value=f.name;
      opt.textContent=f.name;
      select.appendChild(opt);
    });
    if(select.options.length===0){
      select.innerHTML="<option>（KMZが見つかりません）</option>";
    }
  }catch(e){
    alert("GitHubデータ取得に失敗："+e.message);
  }
}
loadKmzList();

// ===== KMZ読込 =====
document.getElementById("loadKmz").addEventListener("click",async()=>{
  const sel=document.getElementById("kmzSelect").value;
  if(!sel) return alert("KMZを選択してください");
  const url=RAW_BASE+encodeURIComponent(sel);
  await loadFromUrl(url);
});

async function loadFromUrl(url){
  showToast("KMZを読み込み中...");
  try{
    const resp=await fetch(url);
    if(!resp.ok) throw new Error("取得失敗");
    const buf=await resp.arrayBuffer();
    const blob=new Blob([buf]);
    await handleKmlKmzFile(blob,url.split("/").pop());
    showToast("KMZ読み込み完了");
  }catch(e){
    alert("読込エラー："+e.message);
  }
}

// ===== ローカルファイル読込 =====
document.getElementById("file").addEventListener("change",async(e)=>{
  const file=e.target.files[0];
  if(!file) return;
  document.getElementById("fname").textContent=file.name;
  await handleKmlKmzFile(file,file.name);
});

async function handleKmlKmzFile(fileBlob,fileName){
  try{
    let kmlText="";
    if(fileName.endsWith(".kmz")){
      const zip=new JSZip();
      const loaded=await zip.loadAsync(fileBlob);
      const kmlFile=Object.keys(loaded.files).find(f=>f.endsWith(".kml"));
      if(!kmlFile) throw new Error("KMZ内にKMLなし");
      kmlText=await loaded.file(kmlFile).async("text");
    }else{
      kmlText=await fileBlob.text();
    }
    parseAndDisplayKml(kmlText);
  }catch(err){alert("解析エラー："+err.message);}
}

function parseAndDisplayKml(kmlText){
  const parser=new DOMParser();
  const kmlDom=parser.parseFromString(kmlText,"text/xml");
  const geojson=toGeoJSON.kml(kmlDom);
  if(currentLayer){map.removeLayer(currentLayer);}
  currentLayer=L.geoJSON(geojson,{
    style:{color:"#ff6600",weight:4},
    onEachFeature:(f,l)=>{
      if(f.geometry.type==="Point" && f.properties?.name){
        l.bindPopup(f.properties.name);
        routePoints.push({name:f.properties.name,coords:[f.geometry.coordinates[1],f.geometry.coordinates[0]]});
      }
    }
  }).addTo(map);
  try{map.fitBounds(currentLayer.getBounds());}catch{}
}

// ===== 音声案内 =====
let synth = window.speechSynthesis;
function speak(text){
  const u=new SpeechSynthesisUtterance(text);
  u.lang="ja-JP";
  u.pitch=1.0;
  u.rate=1.0;
  synth.speak(u);
}

// ===== GPS追跡・通知 =====
document.getElementById("start").addEventListener("click",()=>{
  if(routePoints.length===0){alert("ルートを読み込んでください");return;}
  showToast("評価を開始します");
  document.getElementById("recBadge").style.display="flex";
  speak("評価を開始します");
  startTracking();
});

document.getElementById("recenter").addEventListener("click",()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      map.setView([p.coords.latitude,p.coords.longitude],16);
    });
  }
});

document.getElementById("cp").addEventListener("click",()=>{
  showToast("チェックポイント登録");
});

function startTracking(){
  if(!navigator.geolocation){
    alert("GPSが利用できません");
    return;
  }
  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;
    const current=[lat,lon];
    const meMarker=L.circleMarker(current,{radius:8,color:"red"}).addTo(map);
    setTimeout(()=>map.removeLayer(meMarker),8000);

    // 近距離ポイントを検出
    for(const p of routePoints){
      const dist=getDistance(current,p.coords);
      if(dist<120 && !p.notified){
        speak(`${p.name} に近づきました`);
        showToast(`${p.name} に近づきました`);
        p.notified=true;
      }
    }
  },err=>{console.warn(err);},{enableHighAccuracy:true});
}

function getDistance(a,b){
  const R=6371000;
  const dLat=(b[0]-a[0])*Math.PI/180;
  const dLon=(b[1]-a[1])*Math.PI/180;
  const lat1=a[0]*Math.PI/180;
  const lat2=b[0]*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.style.display="block";
  setTimeout(()=>t.style.display="none",2000);
}
</script>
</body>
</html>
