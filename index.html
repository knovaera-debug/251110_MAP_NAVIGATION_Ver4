<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAPãƒŠãƒ“ Ver5 - è©•ä¾¡ãƒ«ãƒ¼ãƒˆï¼†éŸ³å£°æ¡ˆå†…</title>

  <link rel="stylesheet" href="leaflet.css" />
  <script src="leaflet.js"></script>
  <script src="jszip.min.js"></script>
  <script src="togeojson.umd.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    #panel {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 10px;
      box-shadow: 0 0 5px #888;
      font-size: 14px;
    }
    button {
      width: 100%; margin-top: 6px; height: 36px; border-radius: 8px;
      border: none; background: #0078ff; color: white; font-weight: bold;
    }
    #toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.75); color: #fff; padding: 10px 20px;
      border-radius: 10px; display: none; font-size: 15px; z-index: 2000;
    }
  </style>
</head>

<body>
  <div id="panel">
    <b>ğŸ“ GitHubãƒ«ãƒ¼ãƒˆé¸æŠ</b><br>
    <select id="githubFileSelect" style="width: 100%; height: 32px; border-radius: 8px; margin-top: 4px;">
      <option value="https://raw.githubusercontent.com/knovaera-debug/251110_MAP_NAVIGATION_Ver4/main/data/Final_%E5%9B%BD%E5%86%85DP%E3%82%B3%E3%83%BC%E3%82%B9%E8%A9%95%E4%BE%A1%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E4%BB%98%E3%81%8D_251007_v10.kmz">
        Final_å›½å†…DPã‚³ãƒ¼ã‚¹è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆä»˜ã_251007_v10.kmzï¼ˆæ­£å¼è©•ä¾¡ç”¨ï¼‰
      </option>
      <option value="https://raw.githubusercontent.com/knovaera-debug/251110_MAP_NAVIGATION_Ver4/main/data/%E3%83%AB%E3%83%BC%E3%83%88Test.kmz">
        ãƒ«ãƒ¼ãƒˆTest.kmzï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
      </option>
    </select>
    <button id="startTracking">ğŸš— è¿½è·¡é–‹å§‹</button>
    <button id="stopTracking" style="background:#999;">â›” åœæ­¢</button>
    <button id="voiceTest" style="background:#00c853;">ğŸ”Š éŸ³å£°ãƒ†ã‚¹ãƒˆ</button>
  </div>

  <div id="map"></div>
  <div id="toast"></div>

  <script>
    // ====== ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º ======
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    // ====== éŸ³å£°å‡ºåŠ› ======
    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      utter.rate = 1.05;
      utter.pitch = 1.0;
      utter.volume = 1.0;
      speechSynthesis.speak(utter);
    }

    // ====== åœ°å›³åˆæœŸåŒ– ======
    const map = L.map('map').setView([35.4, 139.4], 13);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let currentLayer = null;
    let watchId = null;
    let marker = null;
    let pointData = [];

    // ====== GitHub KMZèª­ã¿è¾¼ã¿ ======
    async function loadKMZfromGitHub(url, label) {
      try {
        showToast(`ğŸ“¡ ${label} ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦`);
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('KMZãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');

        const arrayBuffer = await resp.arrayBuffer();
        const zip = await JSZip.loadAsync(arrayBuffer);
        const kmlFile = Object.keys(zip.files).find(name => name.endsWith('.kml'));
        const kmlText = await zip.files[kmlFile].async('text');

        const parser = new DOMParser();
        const kml = parser.parseFromString(kmlText, 'text/xml');
        const geojson = toGeoJSON.kml(kml);

        // æ—¢å­˜ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤
        if (currentLayer) map.removeLayer(currentLayer);
        pointData = [];

        currentLayer = L.geoJSON(geojson, {
          onEachFeature: (feature, layer) => {
            if (feature.geometry.type === 'Point') {
              const name = feature.properties.name || 'ãƒã‚¤ãƒ³ãƒˆ';
              const desc = feature.properties.description || '';
              layer.bindPopup(`<b>${name}</b><br>${desc}`);
              pointData.push({
                name: name,
                lat: feature.geometry.coordinates[1],
                lon: feature.geometry.coordinates[0],
                desc: desc
              });
            }
          },
          style: { color: '#FF7F00', weight: 4 },
          pointToLayer: (feature, latlng) =>
            L.circleMarker(latlng, {
              radius: 6, color: 'blue', fillColor: 'cyan', fillOpacity: 0.8
            })
        }).addTo(map);

        map.fitBounds(currentLayer.getBounds());
        showToast(`âœ… ${label} ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
        speak(`${label} ã®ãƒ«ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      } catch (err) {
        console.error(err);
        showToast(`âš ï¸ ${label} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ`);
        speak(`ãƒ«ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ`);
      }
    }

    // ====== GPSè¿½è·¡ ======
    function startTracking() {
      if (!navigator.geolocation) {
        showToast('âš ï¸ GPSãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        return;
      }
      speak('è©•ä¾¡ã‚’é–‹å§‹ã—ã¾ã™');
      showToast('ğŸš— è¿½è·¡ã‚’é–‹å§‹ã—ã¾ã—ãŸ');

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          if (marker) marker.setLatLng([lat, lon]);
          else marker = L.circleMarker([lat, lon], {
            radius: 8, color: 'red', fillColor: 'red', fillOpacity: 0.9
          }).addTo(map);

          checkProximity(lat, lon);
        },
        (err) => showToast(`GPSã‚¨ãƒ©ãƒ¼: ${err.message}`),
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
      );
    }

    function stopTracking() {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      watchId = null;
      speak('è©•ä¾¡ã‚’çµ‚äº†ã—ã¾ã™');
      showToast('â›” è¿½è·¡ã‚’åœæ­¢ã—ã¾ã—ãŸ');
    }

    // ====== è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆæ¥è¿‘åˆ¤å®š ======
    function checkProximity(lat, lon) {
      for (const p of pointData) {
        const dist = getDistance(lat, lon, p.lat, p.lon);
        if (dist < 120) {
          speak(`ã¾ã‚‚ãªã ${p.name} ã§ã™ã€‚`);
          showToast(`ğŸ“ ${p.name} ã«æ¥è¿‘ (${Math.round(dist)}m)`);
          break;
        }
      }
    }

    // Haversineå¼è·é›¢è¨ˆç®—
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // ====== åˆæœŸåŒ– ======
    document.addEventListener('DOMContentLoaded', () => {
      const select = document.getElementById('githubFileSelect');
      const label = select.options[select.selectedIndex].textContent;
      const url = select.value;
      loadKMZfromGitHub(url, label);

      select.addEventListener('change', (e) => {
        const label = e.target.options[e.target.selectedIndex].textContent;
        const url = e.target.value;
        loadKMZfromGitHub(url, label);
      });

      document.getElementById('startTracking').addEventListener('click', startTracking);
      document.getElementById('stopTracking').addEventListener('click', stopTracking);
      document.getElementById('voiceTest').addEventListener('click', () => speak('éŸ³å£°ãƒ†ã‚¹ãƒˆã§ã™ã€‚'));
    });
  </script>
</body>
</html>
